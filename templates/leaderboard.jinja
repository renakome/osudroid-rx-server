{% extends "base.html" %}

{% block title %}
    {% if country %}
        {{ country }} {% if sortby == 'score' %}Score{% else %}PP{% endif %} Leaderboard
    {% else %}
        Global {% if sortby == 'score' %}Score{% else %}PP{% endif %} Leaderboard
    {% endif %}
{% endblock %}

{% block content %}

<div class="container mx-auto px-4 py-8">
    <div class="text-center mb-10">
        <h1 class="text-4xl font-bold text-primary mb-2">
            {% if country %}
                {{ country }} {% if sortby == 'score' %}Score{% else %}PP{% endif %} Leaderboard
            {% else %}
                Global {% if sortby == 'score' %}Score{% else %}PP{% endif %} Leaderboard
            {% endif %}
        </h1>
        <div class="divider w-24 mx-auto"></div>
    </div>

    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8 bg-base-200 p-4 rounded-xl shadow-md">
        <div class="join w-full md:w-auto">
            <input type="text" id="search-input" placeholder="Search player..." class="input input-bordered join-item w-full md:w-64" />
            <button class="btn btn-primary join-item"><i class="fas fa-search"></i></button>
        </div>

        <div class="flex flex-wrap gap-2 justify-center">
            {% set base_url = "/user/leaderboard" %}
            {% set query_country = "country=" + country if country else "" %}
            {% set has_query = query_country %}

            <div class="join">
                <button
                    class="btn btn-sm join-item {% if sortby == 'score' %}btn-active btn-primary{% endif %}"
                    onclick="location.href='{{ base_url }}{% if has_query %}?{{ query_country }}{% endif %}{% if has_query %}&{% else %}?{% endif %}sortby=score'">
                    Score
                </button>
                <button
                    class="btn btn-sm join-item {% if sortby != 'score' %}btn-active btn-primary{% endif %}"
                    onclick="location.href='{{ base_url }}{% if has_query %}?{{ query_country }}{% endif %}'">
                    PP
                </button>
            </div>

            <select class="select select-bordered select-sm" onchange="redirect(this.value)">
                <option value="/user/leaderboard{% if sortby == 'score' %}?sortby=score{% endif %}">
                    All countries
                </option>
                {% for c in countries %}
                    <option
                        value="/user/leaderboard?country={{ c }}{% if sortby == 'score' %}&sortby=score{% endif %}"
                        {% if c == country %}selected{% endif %}>
                        {{ c }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="overflow-x-auto bg-base-100 rounded-xl shadow-xl border border-base-300">
        <table class="table table-zebra w-full" id="leaderboard-table">
            <thead class="bg-base-300">
                <tr>
                    <th class="text-center w-20">Rank</th>
                    <th>Player</th>
                    <th class="text-right">{% if sortby == 'score' %}Ranked Score{% else %}PP{% endif %}</th>
                    <th class="text-center">Plays</th>
                    <th class="text-center">ID</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
                {% for player in leaderboard %}
                <tr class="hover">
                    <td class="text-center font-bold">
                        {% set rank = player.country_score_rank if (country and sortby == 'score') else (player.country_pp_rank if country else (player.score_rank if sortby == 'score' else player.pp_rank)) %}
                        {% if rank == 1 %}
                            <div class="badge badge-warning gap-1">#1</div>
                        {% elif rank == 2 %}
                            <div class="badge badge-ghost bg-slate-300 text-slate-800 gap-1">#2</div>
                        {% elif rank == 3 %}
                            <div class="badge badge-ghost bg-orange-400 text-orange-900 gap-1">#3</div>
                        {% else %}
                            #{{ rank }}
                        {% endif %}
                    </td>
                    <td>
                        <div class="flex items-center gap-3">
                            <div class="avatar placeholder">
                                <div class="bg-neutral text-neutral-content rounded-full w-8">
                                    <span>{{ player.username[0] | upper }}</span>
                                </div>
                            </div>
                            <a href="/user/profile.php?id={{ player.id }}" class="link link-hover font-semibold text-primary">{{ player.username }}</a>
                        </div>
                    </td>
                    <td class="text-right font-mono">
                        {% if sortby == 'score' %}
                            {{ "{:,}".format(player.rscore) }}
                        {% else %}
                            {{ "{:,.2f}".format(player.pp) }}
                        {% endif %}
                    </td>
                    <td class="text-center">{{ player.plays }}</td>
                    <td class="text-center opacity-50 text-xs">{{ player.id }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="flex justify-center mt-8">
        <div class="join">
            <button id="prev-page" class="join-item btn btn-outline btn-sm" disabled>«</button>
            <button class="join-item btn btn-sm no-animation">Page <span id="current-page-num">1</span></button>
            <button id="next-page" class="join-item btn btn-outline btn-sm">»</button>
        </div>
    </div>
</div>

<script>
    function redirect(url) {
        if (url) {
            window.location.href = url;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const tableBody = document.querySelector('#leaderboard-body');
        let allRows = Array.from(tableBody.querySelectorAll('tr'));
        const searchInput = document.getElementById('search-input');
        const perPage = 15;
        let currentPage = 1;
        let filteredRows = allRows.slice();

        function displayPage(page) {
            const start = (page - 1) * perPage;
            const end = start + perPage;
            allRows.forEach(row => (row.style.display = 'none'));
            filteredRows.slice(start, end).forEach(row => row.style.display = '');
            document.getElementById('prev-page').disabled = page === 1;
            document.getElementById('next-page').disabled = end >= filteredRows.length;
            document.getElementById('current-page-num').textContent = page;
        }

        function updateTable() {
            tableBody.innerHTML = '';
            filteredRows.forEach(row => tableBody.appendChild(row));
            displayPage(currentPage);
        }

        function filterTable() {
            const query = searchInput.value.toLowerCase().trim();
            filteredRows = allRows.filter(row => {
                return row.cells[1].textContent.toLowerCase().includes(query);
            });
            currentPage = 1;
            updateTable();
        }

        searchInput.addEventListener('input', filterTable);

        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                displayPage(currentPage);
            }
        });

        document.getElementById('next-page').addEventListener('click', () => {
            const maxPage = Math.ceil(filteredRows.length / perPage);
            if (currentPage < maxPage) {
                currentPage++;
                displayPage(currentPage);
            }
        });

        displayPage(currentPage);
    });
</script>
{% endblock %}
